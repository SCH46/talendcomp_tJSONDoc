package de.jlo.talendcomp.json;

import static org.junit.Assert.assertTrue;

import org.junit.Test;

import com.fasterxml.jackson.databind.JsonNode;
import com.github.fge.jsonschema.core.report.ProcessingMessage;
import com.github.fge.jsonschema.core.report.ProcessingReport;
import com.github.fge.jsonschema.main.JsonSchemaFactory;
import com.github.fge.jsonschema.main.JsonValidator;

public class TestSchemaValidation {
	
	String jsonDocStr = "{\n"
		    + "   \"created_byX\" : 101,\n"
		    + "   \"data_status_id\" : 1,\n"
		    + "   \"process_status_id\" : 1,\n"
		    + "   \"participation\" : {\n"
		    + "      \"product_id\" : 100,\n"
		    + "      \"role_id\" : 1087,\n"
		    + "      \"function_id\" : 1100,\n"
		    + "      \"shooting_days\" : 12,\n"
		    + "      \"participation_date\" : \"2012-01-01T11:22:33.999\",\n"
		    + "      \"source_id\" : 102,\n"
		    + "      \"participant\" : {\n"
		    + "         \"participant_id\" : 103\n"
		    + "      },\n"
		    + "      \"pseudonym\" : {\n"
		    + "         \"pseudonym_id\" : null,\n"
		    + "         \"nametype_id\" : 5643,\n"
		    + "         \"salutation\" : null,\n"
		    + "         \"title\" : \"Jan\",\n"
		    + "         \"firstname_supplement\" : null,\n"
		    + "         \"firstname\" : null,\n"
		    + "         \"name\" : \"The Symbol\",\n"
		    + "         \"name_supplement\" : null\n"
		    + "      },\n"
		    + "      \"participantname\" : {\n"
		    + "         \"participant_name_id\" : null,\n"
		    + "         \"nametype_id\" : null,\n"
		    + "         \"salutation\" : null,\n"
		    + "         \"title\" : null,\n"
		    + "         \"firstname_supplement\" : null,\n"
		    + "         \"firstname\" : null,\n"
		    + "         \"name\" : null,\n"
		    + "         \"name_supplement\" : null\n"
		    + "      },\n"
		    + "      \"rolenames\" : [\n"
		    + "         {\n"
		    + "            \"rolename\" : \"Land√§rztin Anna Maria Strickenbach\",\n"
		    + "            \"language_id\" : 6541,\n"
		    + "            \"default_selection\" : true\n"
		    + "         },\n"
		    + "         {\n"
		    + "            \"rolename\" : \"Country doctor Anna Maria Strickenbach\",\n"
		    + "            \"language_id\" : 6598,\n"
		    + "            \"default_selectionX\" : false\n"
		    + "         }\n"
		    + "      ],\n"
		    + "      \"remarks\" : [\n"
		    + "         {\n"
		    + "            \"remark\" : \"Hat nur in dieser einen Serienepisode mitgewirkt\",\n"
		    + "            \"remark_type_id\" : 4321\n"
		    + "         }\n"
		    + "      ]\n"
		    + "   }\n"
		    + "}";

	String jsonSchemaStr = "{\n"
		    + "    \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n"
		    + "    \"definitions\": {},\n"
		    + "    \"id\": \"http://example.com/example.json\",\n"
		    + "    \"properties\": {\n"
		    + "        \"created_by\": {\n"
		    + "            \"id\": \"/properties/created_by\",\n"
		    + "            \"type\": \"integer\"\n"
		    + "        },\n"
		    + "        \"data_status_id\": {\n"
		    + "            \"id\": \"/properties/data_status_id\",\n"
		    + "            \"type\": \"integer\"\n"
		    + "        },\n"
		    + "        \"participation\": {\n"
		    + "            \"id\": \"/properties/participation\",\n"
		    + "            \"properties\": {\n"
		    + "                \"function_id\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/function_id\",\n"
		    + "                    \"type\": \"integer\"\n"
		    + "                },\n"
		    + "                \"participant\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/participant\",\n"
		    + "                    \"properties\": {\n"
		    + "                        \"participant_id\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participant/properties/participant_id\",\n"
		    + "                            \"type\": \"integer\"\n"
		    + "                        }\n"
		    + "                    },\n"
		    + "                    \"type\": \"object\"\n"
		    + "                },\n"
		    + "                \"participantname\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/participantname\",\n"
		    + "                    \"properties\": {\n"
		    + "                        \"firstname\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/firstname\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"firstname_supplement\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/firstname_supplement\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"name\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/name\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"name_supplement\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/name_supplement\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"nametype_id\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/nametype_id\",\n"
		    + "                            \"type\": [\"integer\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"participant_name_id\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/participant_name_id\",\n"
		    + "                            \"type\": [\"integer\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"salutation\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/salutation\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        },\n"
		    + "                        \"title\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/participantname/properties/title\",\n"
		    + "                            \"type\": [\"string\",\"null\"]\n"
		    + "                        }\n"
		    + "                    },\n"
		    + "                    \"type\": \"object\"\n"
		    + "                },\n"
		    + "                \"participation_date\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/participation_date\",\n"
		    + "                    \"type\": \"string\"\n"
		    + "                },\n"
		    + "                \"product_id\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/product_id\",\n"
		    + "                    \"type\": \"integer\"\n"
		    + "                },\n"
		    + "                \"pseudonym\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/pseudonym\",\n"
		    + "                    \"properties\": {\n"
		    + "                        \"firstname\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/firstname\",\n"
		    + "                            \"type\": \"string\"\n"
		    + "                        },\n"
		    + "                        \"firstname_supplement\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/firstname_supplement\",\n"
		    + "                            \"type\": \"null\"\n"
		    + "                        },\n"
		    + "                        \"name\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/name\",\n"
		    + "                            \"type\": \"string\"\n"
		    + "                        },\n"
		    + "                        \"name_supplement\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/name_supplement\",\n"
		    + "                            \"type\": \"string\"\n"
		    + "                        },\n"
		    + "                        \"nametype_id\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/nametype_id\",\n"
		    + "                            \"type\": \"integer\"\n"
		    + "                        },\n"
		    + "                        \"pseudonym_id\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/pseudonym_id\",\n"
		    + "                            \"type\": \"integer\"\n"
		    + "                        },\n"
		    + "                        \"salutation\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/salutation\",\n"
		    + "                            \"type\": \"string\"\n"
		    + "                        },\n"
		    + "                        \"title\": {\n"
		    + "                            \"id\": \"/properties/participation/properties/pseudonym/properties/title\",\n"
		    + "                            \"type\": \"string\"\n"
		    + "                        }\n"
		    + "                    },\n"
		    + "                    \"type\": \"object\"\n"
		    + "                },\n"
		    + "                \"remarks\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/remarks\",\n"
		    + "                    \"items\": {\n"
		    + "                        \"id\": \"/properties/participation/properties/remarks/items\",\n"
		    + "                        \"properties\": {\n"
		    + "                            \"remark\": {\n"
		    + "                                \"id\": \"/properties/participation/properties/remarks/items/properties/remark\",\n"
		    + "                                \"type\": \"string\"\n"
		    + "                            },\n"
		    + "                            \"remark_type_id\": {\n"
		    + "                                \"id\": \"/properties/participation/properties/remarks/items/properties/remark_type_id\",\n"
		    + "                                \"type\": \"integer\"\n"
		    + "                            }\n"
		    + "                        },\n"
		    + "                        \"type\": \"object\"\n"
		    + "                    },\n"
		    + "                    \"type\": \"array\"\n"
		    + "                },\n"
		    + "                \"role_id\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/role_id\",\n"
		    + "                    \"type\": \"integer\"\n"
		    + "                },\n"
		    + "                \"rolenames\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/rolenames\",\n"
		    + "                    \"items\": {\n"
		    + "                        \"id\": \"/properties/participation/properties/rolenames/items\",\n"
		    + "                        \"properties\": {\n"
		    + "                            \"default_selection\": {\n"
		    + "                                \"id\": \"/properties/participation/properties/rolenames/items/properties/default_selection\",\n"
		    + "                                \"type\": \"boolean\"\n"
		    + "                            },\n"
		    + "                            \"language_id\": {\n"
		    + "                                \"id\": \"/properties/participation/properties/rolenames/items/properties/language_id\",\n"
		    + "                                \"type\": \"integer\"\n"
		    + "                            },\n"
		    + "                            \"rolename\": {\n"
		    + "                                \"id\": \"/properties/participation/properties/rolenames/items/properties/rolename\",\n"
		    + "                                \"type\": \"string\"\n"
		    + "                            }\n"
		    + "                        },\n"
		    + "                        \"additionalProperties\": false,\n"
		    + "                        \"type\": \"object\"\n"
		    + "                    },\n"
		    + "                    \"type\": \"array\"\n"
		    + "                },\n"
		    + "                \"shooting_days\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/shooting_days\",\n"
		    + "                    \"type\": \"integer\"\n"
		    + "                },\n"
		    + "                \"source_id\": {\n"
		    + "                    \"id\": \"/properties/participation/properties/source_id\",\n"
		    + "                    \"type\": \"integer\"\n"
		    + "                }\n"
		    + "            },\n"
		    + "            \"type\": \"object\"\n"
		    + "        },\n"
		    + "        \"process_status_id\": {\n"
		    + "            \"id\": \"/properties/process_status_id\",\n"
		    + "            \"type\": \"integer\"\n"
		    + "        }\n"
		    + "    },\n"
		    + "    \"required\": [\"participation\"],\n"
		    + "    \"additionalProperties\": false,\n"
		    + "    \"type\": \"object\"\n"
		    + "}";
	
	@Test
	public void testValidate() throws Exception {
		JsonNode schemaNode = JsonDocument.parse(jsonSchemaStr);
		JsonNode dataNode = JsonDocument.parse(jsonDocStr);
		final JsonSchemaFactory factory = JsonSchemaFactory.byDefault();
        JsonValidator v = factory.getValidator();
        ProcessingReport report = v.validate(schemaNode, dataNode, true);
        if (report.isSuccess()) {
        	System.out.println("OK");
        } else {
            for (ProcessingMessage message : report) {
            	System.out.println(message.getLogLevel() + ": " + message.getMessage());
            }
        }
//        System.out.println(report);
//        if (!report.toString().contains("success")) {
//            throw new Exception(
//                    report.toString());
//        }
        assertTrue(true);
	}

	@Test
	public void testValidateUsingJsonDocument() throws Exception {
		JsonDocument doc = new JsonDocument(jsonDocStr);
		String schemaId = "project.jobName";
		JsonDocument.setJsonSchema(schemaId, jsonSchemaStr);
		String errors = doc.validate(schemaId);
		if (errors != null) {
			System.out.println(errors);
		} else {
			System.out.println("OK");
		}
		assertTrue(true);
	}

}
